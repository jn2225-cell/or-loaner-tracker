<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OR Loaner Implant Tracker</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        .custom-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; }
    </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans">

<!-- HEADER -->
<header class="bg-blue-700 text-white p-4 shadow-lg sticky top-0 z-50">
    <div class="max-w-4xl mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold">OR Loaner Tracker</h1>
        <div id="user-info" class="text-xs opacity-80">Connectingâ€¦</div>
    </div>
</header>

<!-- MAIN -->
<main class="max-w-4xl mx-auto p-4 mb-20">

<!-- TABS -->
<div class="flex border-b bg-white mb-6">
    <button id="tab-entry" onclick="switchTab('entry')" class="flex-1 py-3 tab-active">New Entry</button>
    <button id="tab-list" onclick="switchTab('list')" class="flex-1 py-3 text-gray-500">Active Trays</button>
    <button id="tab-history" onclick="switchTab('history')" class="flex-1 py-3 text-gray-500">History</button>
</div>

<!-- ENTRY -->
<section id="section-entry">
<div class="bg-white p-6 rounded-xl custom-shadow">
<form id="loaner-form" class="space-y-4">

<input id="patientName" required placeholder="Patient Name" class="w-full p-3 border rounded">
<input id="hospitalNumber" required placeholder="Hospital Number" class="w-full p-3 border rounded">
<input id="companyName" required placeholder="Company Name" class="w-full p-3 border rounded">
<input id="companyContact" placeholder="Company Contact" class="w-full p-3 border rounded">
<input id="receivingPerson" required placeholder="Receiving Staff" class="w-full p-3 border rounded">
<input id="receivingContact" placeholder="Staff Contact" class="w-full p-3 border rounded">

<select id="department" class="w-full p-3 border rounded">
<option>Ortho 1</option>
<option>Ortho 2</option>
<option>Ortho 3</option>
<option>General</option>
<option>Neuro</option>
</select>

<input id="implantType" required placeholder="Implant / Tray" class="w-full p-3 border rounded">

<input id="file-upload" type="file" accept="image/*" class="w-full">

<img id="image-preview" class="hidden max-h-40 border rounded">

<button id="submit-btn" class="w-full bg-blue-600 text-white py-3 rounded">
Save Entry
</button>

</form>
</div>
</section>

<!-- ACTIVE -->
<section id="section-list" class="hidden">
<div id="active-list" class="space-y-4"></div>
</section>

<!-- HISTORY -->
<section id="section-history" class="hidden">
<div id="history-list" class="space-y-4"></div>
</section>

</main>

<!-- IMAGE MODAL -->
<div id="image-modal" class="fixed inset-0 bg-black/90 hidden items-center justify-center">
<img id="modal-img" class="max-h-[90vh]">
</div>

<!-- ================= FIREBASE + APP ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* ðŸ”¹ CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBbx2eSpISzDA1puvnynE3pzGT1E6jXkm8",
  authDomain: "or-loaner-tracker.firebaseapp.com",
  projectId: "or-loaner-tracker",
  storageBucket: "or-loaner-tracker.firebasestorage.app",
  messagingSenderId: "152462680465",
  appId: "1:152462680465:web:57ea8cefc1f94ed4f5ba30"
};

/* ðŸ”¹ INIT */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = "or-loaner-tracker";

let currentUser = null;
let selectedImageData = null;
let allItems = [];

/* ðŸ”¹ AUTH */
await signInAnonymously(auth);

onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    document.getElementById("user-info").innerText =
      `Logged in: ${user.uid.substring(0,8)}â€¦`;
    listenData();
  }
});

/* IMAGE */
file-upload.addEventListener("change", e => {
  const r = new FileReader();
  r.onload = ev => {
    selectedImageData = ev.target.result;
    image-preview.src = selectedImageData;
    image-preview.classList.remove("hidden");
  };
  r.readAsDataURL(e.target.files[0]);
});

/* SAVE */
loaner-form.addEventListener("submit", async e => {
  e.preventDefault();
  await addDoc(collection(db,"artifacts",appId,"public","data","loaners"),{
    patientName: patientName.value,
    hospitalNumber: hospitalNumber.value,
    companyName: companyName.value,
    companyContact: companyContact.value,
    receivingPerson: receivingPerson.value,
    receivingContact: receivingContact.value,
    department: department.value,
    implantType: implantType.value,
    imageUrl: selectedImageData,
    status:"In OR",
    createdAt: serverTimestamp(),
    createdBy: currentUser.uid
  });
  e.target.reset();
  image-preview.classList.add("hidden");
  switchTab("list");
});

/* LISTEN */
function listenData(){
  onSnapshot(collection(db,"artifacts",appId,"public","data","loaners"),snap=>{
    allItems=[];
    snap.forEach(d=>allItems.push({id:d.id,...d.data()}));
    render();
  });
}

function render(){
  active-list.innerHTML="";
  history-list.innerHTML="";
  allItems.forEach(i=>{
    const box=`<div class="bg-white p-4 rounded custom-shadow">
      <b>${i.implantType}</b><br>
      ${i.patientName} (${i.hospitalNumber})<br>
      ${i.companyName}
    </div>`;
    (i.status==="Returned"?history-list:active-list).innerHTML+=box;
  });
}

/* TABS */
window.switchTab = tab =>{
["entry","list","history"].forEach(t=>{
  document.getElementById(`section-${t}`).classList.toggle("hidden",t!==tab);
  document.getElementById(`tab-${t}`).classList.toggle("tab-active",t===tab);
});
};
</script>

</body>
</html>
